# ==============================================================================
# ERP Arabic OCR Microservice - Apache HTTPS/SSL Configuration
# ==============================================================================
#
# This configuration enables HTTPS with modern SSL/TLS settings.
# Includes HTTP to HTTPS redirect and security headers.
#
# Prerequisites:
#   - SSL certificate and key files
#   - Apache mod_ssl enabled
#
# Certificate Generation (self-signed for development):
#   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout /etc/ssl/private/ocr.key \
#     -out /etc/ssl/certs/ocr.crt \
#     -subj "/CN=ocr.erp.local"
#
# Installation (Linux):
#   sudo cp erp-ocr-ssl.conf /etc/apache2/sites-available/
#   sudo a2ensite erp-ocr-ssl.conf
#   sudo a2enmod ssl proxy proxy_http headers rewrite
#   sudo systemctl restart apache2
#
# ==============================================================================

# Enable required modules
# LoadModule ssl_module modules/mod_ssl.so
# LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

# ==============================================================================
# HTTP to HTTPS Redirect
# ==============================================================================
<VirtualHost *:80>
    ServerName ocr.erp.local
    ServerAlias localhost

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

    # Alternative: Simple redirect
    # Redirect permanent / https://ocr.erp.local/
</VirtualHost>

# ==============================================================================
# HTTPS Virtual Host
# ==============================================================================
<VirtualHost *:443>
    # ===========================================================================
    # Server Identification
    # ===========================================================================
    ServerName ocr.erp.local
    ServerAlias localhost
    ServerAdmin admin@erp.local

    # Document root
    DocumentRoot "C:/wamp64/www/OCR_2"

    # ===========================================================================
    # SSL Configuration
    # ===========================================================================
    SSLEngine on

    # Certificate files
    # For production, use Let's Encrypt or commercial certificates
    SSLCertificateFile "/etc/ssl/certs/ocr.crt"
    SSLCertificateKeyFile "/etc/ssl/private/ocr.key"

    # Certificate chain (if using intermediate CA)
    # SSLCertificateChainFile "/etc/ssl/certs/ocr-chain.crt"

    # ===========================================================================
    # Modern SSL/TLS Settings (Mozilla Modern Configuration)
    # ===========================================================================

    # Protocols: Only TLS 1.2 and 1.3
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1

    # Cipher suites (modern, secure ciphers only)
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

    # Prefer server cipher order
    SSLHonorCipherOrder on

    # Enable OCSP Stapling (if certificate supports it)
    SSLUseStapling off
    # SSLStaplingResponderTimeout 5
    # SSLStaplingReturnResponderErrors off
    # SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

    # Session cache
    SSLSessionCache "shmcb:logs/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # ===========================================================================
    # Security Headers
    # ===========================================================================
    <IfModule mod_headers.c>
        # HTTP Strict Transport Security (HSTS)
        # max-age: 1 year = 31536000 seconds
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Prevent MIME type sniffing
        Header always set X-Content-Type-Options "nosniff"

        # Prevent clickjacking
        Header always set X-Frame-Options "SAMEORIGIN"

        # XSS Protection
        Header always set X-XSS-Protection "1; mode=block"

        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy (adjust as needed)
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'"

        # Permissions Policy
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    </IfModule>

    # ===========================================================================
    # Logging
    # ===========================================================================
    ErrorLog "logs/ocr-ssl-error.log"
    CustomLog "logs/ocr-ssl-access.log" combined

    LogLevel warn

    # ===========================================================================
    # Directory Configuration
    # ===========================================================================
    <Directory "C:/wamp64/www/OCR_2">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ===========================================================================
    # Reverse Proxy Configuration
    # ===========================================================================
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 120

    <Proxy *>
        Require all granted
    </Proxy>

    # Route API requests to Gunicorn backend
    ProxyPass /api/v2/ocr http://127.0.0.1:8000/api/v2/ocr connectiontimeout=10 timeout=120 retry=0
    ProxyPassReverse /api/v2/ocr http://127.0.0.1:8000/api/v2/ocr

    # ===========================================================================
    # CORS Headers for API
    # ===========================================================================
    <IfModule mod_headers.c>
        <LocationMatch "^/api/">
            Header always set Access-Control-Allow-Origin "*"
            Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key, X-Request-ID"
            Header always set Access-Control-Max-Age "3600"
            Header always set Access-Control-Expose-Headers "X-Request-ID, X-Processing-Time-Ms"
        </LocationMatch>

        # Handle preflight OPTIONS requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^/api/(.*)$ - [R=204,L]
    </IfModule>

    # ===========================================================================
    # Request Size Limits
    # ===========================================================================
    LimitRequestBody 52428800

    # ===========================================================================
    # Health Check Endpoint
    # ===========================================================================
    <Location "/health">
        ProxyPass http://127.0.0.1:8000/api/v2/ocr/health
        ProxyPassReverse http://127.0.0.1:8000/api/v2/ocr/health
    </Location>

    # ===========================================================================
    # Metrics Endpoint (with IP restriction)
    # ===========================================================================
    <Location "/metrics">
        ProxyPass http://127.0.0.1:8000/api/v2/ocr/metrics
        ProxyPassReverse http://127.0.0.1:8000/api/v2/ocr/metrics

        # Restrict to internal networks
        <RequireAny>
            Require ip 127.0.0.1
            Require ip 192.168.0.0/16
            Require ip 10.0.0.0/8
            Require ip 172.16.0.0/12
        </RequireAny>
    </Location>

    # ===========================================================================
    # Static File Caching
    # ===========================================================================
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType text/css "access plus 1 week"
        ExpiresByType application/javascript "access plus 1 week"

        <LocationMatch "^/api/">
            ExpiresActive Off
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        </LocationMatch>
    </IfModule>

    # ===========================================================================
    # Compression
    # ===========================================================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
        AddOutputFilterByType DEFLATE application/json application/javascript application/xml
    </IfModule>

</VirtualHost>

# ==============================================================================
# SSL Stapling Cache (global, outside VirtualHost)
# ==============================================================================
# SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

# ==============================================================================
# Additional Security: Disable weak protocols globally
# ==============================================================================
# SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
# SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
# SSLHonorCipherOrder on

# ==============================================================================
# Notes:
# ==============================================================================
#
# 1. For Let's Encrypt certificates:
#    sudo certbot --apache -d ocr.erp.local
#
# 2. For testing SSL configuration:
#    https://www.ssllabs.com/ssltest/
#
# 3. Renew certificates automatically:
#    sudo certbot renew --dry-run
#
# 4. Check certificate expiry:
#    openssl x509 -enddate -noout -in /etc/ssl/certs/ocr.crt
#
# ==============================================================================
