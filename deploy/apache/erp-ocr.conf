# ==============================================================================
# ERP Arabic OCR Microservice - Apache HTTP Configuration
# ==============================================================================
#
# This configuration sets up Apache as a reverse proxy for the OCR microservice.
# The OCR service runs on Gunicorn (port 8000) and Apache proxies requests to it.
#
# Installation (Linux):
#   sudo cp erp-ocr.conf /etc/apache2/sites-available/
#   sudo a2ensite erp-ocr.conf
#   sudo a2enmod proxy proxy_http headers rewrite
#   sudo systemctl restart apache2
#
# Installation (WAMP on Windows):
#   Copy to: C:\wamp64\bin\apache\apache2.x.x\conf\extra\
#   Add to httpd.conf: Include conf/extra/erp-ocr.conf
#
# ==============================================================================

# Enable required modules (uncomment if not enabled globally)
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule headers_module modules/mod_headers.so
# LoadModule rewrite_module modules/mod_rewrite.so

<VirtualHost *:80>
    # ===========================================================================
    # Server Identification
    # ===========================================================================
    ServerName ocr.erp.local
    ServerAlias localhost ocr.localhost
    ServerAdmin admin@erp.local

    # Document root for static files and PHP ERP application
    DocumentRoot "C:/wamp64/www/OCR_2"

    # ===========================================================================
    # Logging
    # ===========================================================================
    ErrorLog "logs/ocr-error.log"
    CustomLog "logs/ocr-access.log" combined

    # Log level (debug, info, notice, warn, error, crit, alert, emerg)
    LogLevel warn

    # ===========================================================================
    # Directory Configuration
    # ===========================================================================
    <Directory "C:/wamp64/www/OCR_2">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ===========================================================================
    # Reverse Proxy Configuration for OCR API
    # ===========================================================================

    # Proxy settings
    ProxyRequests Off
    ProxyPreserveHost On

    # Proxy timeout (OCR can take time)
    ProxyTimeout 120

    # Backend connection settings
    <Proxy *>
        Require all granted
    </Proxy>

    # Route /api/v2/ocr/* requests to Gunicorn backend
    ProxyPass /api/v2/ocr http://127.0.0.1:8000/api/v2/ocr connectiontimeout=10 timeout=120 retry=0
    ProxyPassReverse /api/v2/ocr http://127.0.0.1:8000/api/v2/ocr

    # Alternative: Route all /api/* requests to backend
    # ProxyPass /api http://127.0.0.1:8000/api connectiontimeout=10 timeout=120 retry=0
    # ProxyPassReverse /api http://127.0.0.1:8000/api

    # ===========================================================================
    # CORS Headers
    # ===========================================================================
    <IfModule mod_headers.c>
        # Allow CORS for API endpoints
        <LocationMatch "^/api/">
            Header always set Access-Control-Allow-Origin "*"
            Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key, X-Request-ID"
            Header always set Access-Control-Max-Age "3600"
            Header always set Access-Control-Expose-Headers "X-Request-ID, X-Processing-Time-Ms"
        </LocationMatch>

        # Handle preflight OPTIONS requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^/api/(.*)$ - [R=204,L]
    </IfModule>

    # ===========================================================================
    # Security Headers
    # ===========================================================================
    <IfModule mod_headers.c>
        # Prevent MIME type sniffing
        Header always set X-Content-Type-Options "nosniff"

        # Prevent clickjacking
        Header always set X-Frame-Options "SAMEORIGIN"

        # XSS Protection
        Header always set X-XSS-Protection "1; mode=block"

        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>

    # ===========================================================================
    # Request Size Limits
    # ===========================================================================
    # Maximum request body size (50MB for large documents)
    LimitRequestBody 52428800

    # ===========================================================================
    # PHP Handler (for ERP application if needed)
    # ===========================================================================
    <IfModule mod_php.c>
        <FilesMatch \.php$>
            SetHandler application/x-httpd-php
        </FilesMatch>
    </IfModule>

    # ===========================================================================
    # Static File Caching
    # ===========================================================================
    <IfModule mod_expires.c>
        ExpiresActive On

        # Cache static assets
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType text/css "access plus 1 week"
        ExpiresByType application/javascript "access plus 1 week"

        # Don't cache API responses
        <LocationMatch "^/api/">
            ExpiresActive Off
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
            Header set Pragma "no-cache"
        </LocationMatch>
    </IfModule>

    # ===========================================================================
    # Compression
    # ===========================================================================
    <IfModule mod_deflate.c>
        # Compress text-based responses
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/xml
    </IfModule>

    # ===========================================================================
    # Health Check Endpoint (bypass proxy for local checks)
    # ===========================================================================
    <Location "/health">
        ProxyPass http://127.0.0.1:8000/api/v2/ocr/health
        ProxyPassReverse http://127.0.0.1:8000/api/v2/ocr/health
    </Location>

    # ===========================================================================
    # Metrics Endpoint (Prometheus scraping)
    # ===========================================================================
    <Location "/metrics">
        ProxyPass http://127.0.0.1:8000/api/v2/ocr/metrics
        ProxyPassReverse http://127.0.0.1:8000/api/v2/ocr/metrics

        # Optional: Restrict to internal IPs
        # Require ip 127.0.0.1 192.168.1.0/24 10.0.0.0/8
    </Location>

</VirtualHost>

# ==============================================================================
# Load Balancing Configuration (Optional - for multiple backends)
# ==============================================================================
#
# <Proxy "balancer://ocr-cluster">
#     BalancerMember http://127.0.0.1:8000 route=ocr1
#     BalancerMember http://127.0.0.1:8001 route=ocr2
#     ProxySet lbmethod=byrequests
# </Proxy>
#
# ProxyPass /api/v2/ocr balancer://ocr-cluster/api/v2/ocr
# ProxyPassReverse /api/v2/ocr balancer://ocr-cluster/api/v2/ocr
#
# ==============================================================================
